<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宮本研面談予約システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="user-grid.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>

<body>
    <div class="background-decor"></div>
    <header class="app-header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="text-align: left;">
                    <h1>宮本研面談予約システム</h1>
                    <p class="subtitle">Miyamoto Lab Interview Reservation System</p>
                </div>
                <div id="userAccountArea">
                    <button id="loginOpenBtn" class="account-btn"><i class="fas fa-user-circle"></i> ログイン / 登録</button>
                    <div id="userInfoDisplay" style="display: none;">
                        <span id="loggedInUserName" class="user-name-span"></span>
                        <button id="myPageBtn" class="account-btn header-action-btn"><i class="fas fa-id-card"></i>
                            マイページ</button>
                        <button id="userSettingsBtn" class="account-btn header-action-btn"><i class="fas fa-cog"></i>
                            設定</button>
                        <button id="logoutBtn" class="text-btn header-logout-btn">ログアウト</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container main-content">
        <!-- Dashboard / Sidebar -->
        <aside class="dashboard-sidebar">
            <!-- Admin Quick Actions (Visible only to owners/admins) -->
            <div id="adminQuickActions"
                style="display:none; margin-bottom: 2rem; padding: 1rem; background: #ebf8ff; border: 1px solid #90cdf4; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h3
                    style="color: #2b6cb0; margin-top: 0; font-size: 1rem; border-bottom: 1px solid #bee3f8; padding-bottom: 0.5rem; margin-bottom: 0.8rem;">
                    <i class="fas fa-tools"></i> 管理クイックメニュー
                </h3>
                <button id="sidebarStudentHistoryBtn" class="account-btn"
                    style="width: 100%; text-align: left; margin-bottom: 0.6rem; background: #3182ce; color: white; border: none; padding: 0.6rem;">
                    <i class="fas fa-history"></i> 学生情報・状況確認
                </button>
                <button id="sidebarAllReservationsBtn" class="account-btn"
                    style="width: 100%; text-align: left; background: #4a5568; color: white; border: none; padding: 0.6rem;">
                    <i class="fas fa-list"></i> 全予約一覧表示
                </button>
            </div>

            <div id="myReservationsSection"
                style="display:none; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px dashed #e2e8f0;">
                <h3>
                    <i class="fas fa-user-clock" style="margin-right:0.5rem; color: #2b6cb0;"></i>あなたの予約
                </h3>
                <div id="myReservationList" class="dashboard-list"></div>
            </div>

            <h3>
                <i class="fas fa-bookmark" style="margin-right:0.5rem;"></i>予約状況ピックアップ
            </h3>

            <!-- Today -->
            <div class="dashboard-section">
                <h4>今日の予約</h4>
                <div id="dashboardTodayList" class="dashboard-list">読み込み中...</div>
            </div>

            <!-- This Week -->
            <div class="dashboard-section">
                <h4>今週の予約 (以降)</h4>
                <div id="dashboardWeekList" class="dashboard-list">読み込み中...</div>
            </div>
        </aside>

        <!-- Calendar Section (Existing) -->
        <section class="calendar-section">
            <div class="calendar-header">
                <button id="prevMonth" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
                <h2 id="currentMonthDisplay">2026年 1月</h2>
                <button id="nextMonth" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="admin-controls-area">
                <button id="adminToggleBtn" class="text-btn">管理者モード: OFF</button>
                <button id="syncDataBtn" class="text-btn" style="margin-left: 1rem;"><i class="fas fa-sync-alt"></i>
                    最新に更新</button>
                <button id="allReservationsBtn" class="text-btn" style="display:none; margin-left: 1rem;"><i
                        class="fas fa-list"></i> 全予約</button>
                <button id="batchRegistrationBtn" class="text-btn" style="display:none; margin-left: 1rem;"><i
                        class="fas fa-calendar-plus"></i> 一括登録</button>
                <button id="adminMenuBtn" class="text-btn"
                    style="display:none; margin-left: 1rem; color: var(--color-primary); font-weight: bold;"><i
                        class="fas fa-tools"></i> 管理メニュー</button>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Day headers will be injected here -->
                <!-- Dates will be injected here -->
            </div>

            <div class="calendar-legend">
                <div class="legend-item"><span class="dot available"></span>予約可能</div>
                <div class="legend-item"><span class="dot few"></span>残りわずか</div>
                <div class="legend-item"><span class="dot full"></span>満席</div>
            </div>
        </section>
    </main>

    <!-- Reservation Modal -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalDateTitle">予約情報の入力</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <!-- Schedule View (Step 1) -->
            <div id="bookingScheduleView">
                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                    希望の時間帯を選択してください。<br>
                    <span style="font-size: 0.8rem;">※ すでに予約が入っている枠には予約者名が表示されます。</span>
                </p>
                <div id="dailyScheduleList" class="schedule-list">
                    <!-- Dynamically generated slots -->
                </div>
            </div>

            <!-- Booking Form (Step 2) -->
            <div id="bookingFormContainer" style="display: none;">
                <button type="button" id="backToScheduleBtn" class="text-btn"
                    style="margin-bottom: 1rem; padding-left: 0;">
                    <i class="fas fa-arrow-left"></i> 日程選択に戻る
                </button>
                <form id="reservationForm">
                    <div class="form-group">
                        <label for="name">氏名</label>
                        <input type="text" id="name" name="name" required placeholder="宮本 太郎">
                    </div>
                    <div class="form-group">
                        <label for="studentId">学籍番号</label>
                        <input type="text" id="studentId" name="studentId" required placeholder="00X0000">
                    </div>
                    <div class="form-group">
                        <label for="email">メールアドレス (通知送付先: 任意)</label>
                        <input type="email" id="email" name="email" placeholder="student@university.ac.jp">
                    </div>
                    <div class="form-group">
                        <label for="attendees">参加人数 (本人含む)</label>
                        <input type="number" id="attendees" name="attendees" min="1" value="1" required>
                    </div>

                    <!-- Dynamic Fields for Additional Attendees -->
                    <div id="additionalAttendeesContainer"
                        style="margin-top: 1rem; padding-left: 1rem; border-left: 2px solid #e2e8f0;">
                        <!-- JS will populate: Name, StudentID, Email for each extra person -->
                    </div>
                    <div class="form-group">
                        <label for="format">希望形式</label>
                        <select id="format" name="format">
                            <option value="presential">対面</option>
                            <option value="remote">リモート (Zoom/Teams)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="duration">所要時間</label>
                        <select id="duration" name="duration">
                            <option value="1">30分</option>
                            <option value="2">60分</option>
                            <option value="3">90分</option>
                            <option value="4">120分</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selectedTimeDisplay">日時</label>
                        <input type="text" id="selectedTimeDisplay" readonly
                            style="background-color: #f7fafc; border: none; font-weight: bold; color: var(--color-primary);">
                        <input type="hidden" id="timeSlot" name="timeSlot" required>
                        <!-- Hidden fields for Edit Mode -->
                        <input type="hidden" id="editMode" name="editMode" value="false">
                        <input type="hidden" id="originalTimestamp" name="originalTimestamp">
                    </div>
                    <div class="form-group">
                        <label for="type">面談内容</label>
                        <select id="type" name="type">
                            <option value="research">研究相談</option>
                            <option value="report">進捗報告</option>
                            <option value="other">その他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>面談の公開設定</label>
                        <div style="display: flex; gap: 1rem; margin-top: 0.25rem;">
                            <label style="font-weight: normal; cursor: pointer;">
                                <input type="radio" name="privacyType" value="private" checked> 1対1 (個別)
                            </label>
                            <label style="font-weight: normal; cursor: pointer;">
                                <input type="radio" name="privacyType" value="open"> 他の学生の同席を許可
                            </label>
                        </div>
                        <p style="font-size: 0.8rem; color: #718096; margin-top: 4px;">
                            ※「同席を許可」を選択すると、同じ時間に他の学生も予約できるようになります。
                        </p>
                    </div>
                    <!-- Previously Attendees were here, now moved up -->

                    <div class="actions">
                        <button type="submit" class="submit-btn">予約する</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Day Management Modal -->
    <div id="adminDayModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3 id="adminDateTitle">管理者設定</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <div class="admin-section">
                <h4>現在の予約一覧</h4>
                <ul id="adminReservationsList" class="reservation-list" style="margin-bottom:0;">
                    <!-- List items generated dynamically -->
                </ul>
            </div>

            <div class="admin-section" style="border-top: 2px dashed #e2e8f0; margin-top: 1.5rem; padding-top: 1.5rem;">
                <h4>予約枠の管理</h4>
                <!-- Range Selector -->
                <div
                    style="background: #f7fafc; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #e2e8f0;">
                    <div style="font-size: 0.85rem; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600;">
                        範囲指定で追加（一括チェック）</div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="dailyBatchStartTime"
                            style="padding: 0.4rem; border-radius: 4px; border: 1px solid #cbd5e0; font-size: 0.9rem; flex:1;"></select>
                        <span style="color: #718096;">～</span>
                        <select id="dailyBatchEndTime"
                            style="padding: 0.4rem; border-radius: 4px; border: 1px solid #cbd5e0; font-size: 0.9rem; flex:1;"></select>
                        <button id="dailyBatchApplyBtn" type="button"
                            style="background: var(--color-primary); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">反映</button>
                    </div>
                </div>

                <div id="adminTimeSlots" class="admin-slots-grid">
                    <!-- Checkboxes generated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Password Login Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>管理者認証</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="adminUserSelect">ログインユーザー</label>
                    <select id="adminUserSelect"
                        style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 1rem;">
                        <!-- Options generated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="adminPassword">パスワードを入力してください</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="actions">
                    <button type="submit" class="submit-btn" id="loginSubmitBtn">ログイン</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>パスワード変更</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPasswordInput">現在のパスワード</label>
                    <input type="password" id="currentPasswordInput" required>
                </div>
                <div class="form-group">
                    <label for="newPasswordInput">新しいパスワード</label>
                    <input type="password" id="newPasswordInput" required>
                </div>
                <div class="actions">
                    <button type="submit" class="submit-btn">変更する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- All Reservations Modal -->
    <div id="allReservationsModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3>全予約一覧</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="admin-section">
                <div class="filter-options" style="margin-bottom: 1rem; text-align: right;">
                    <button id="togglePastReservationsBtn" class="text-btn"
                        style="font-size: 0.8rem; margin-right: 1rem; color: #718096;">
                        <i class="fas fa-history"></i> 過去の予約を表示
                    </button>
                    <button id="copyAllDataBtn" class="text-btn" style="font-size: 0.8rem;">データをコピー</button>
                </div>
                <ul id="allReservationsList" class="reservation-list" style="max-height: 400px;">
                    <!-- List items generated dynamically -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Owner Management Modal -->
    <div id="ownerManagementModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3>オーナー情報管理</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <!-- Add New Owner Form -->
            <div class="admin-section"
                style="border-bottom: 1px solid var(--color-border); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                <h4>新規登録</h4>
                <form id="addOwnerForm">
                    <div class="form-group" style="margin-bottom: 0.8rem;">
                        <input type="text" id="ownerName" placeholder="氏名" required
                            style="padding: 0.5rem; font-size: 0.9rem;">
                    </div>
                    <div class="form-group"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.8rem;">
                        <select id="ownerStatus" style="padding: 0.5rem; font-size: 0.9rem;">
                            <option value="admin">システム管理者</option>
                            <option value="faculty">教員</option>
                            <option value="student_undergrad">学部生</option>
                            <option value="student_master">院生</option>
                        </select>
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 8px; background: #fff;">
                            <input type="checkbox" id="ownerNotify" style="width: auto;" checked>
                            <label for="ownerNotify"
                                style="margin: 0; font-size: 0.9rem; cursor: pointer;">通知を受け取る</label>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0.8rem;">
                        <input type="email" id="ownerEmail" placeholder="メールアドレス" required
                            style="padding: 0.5rem; font-size: 0.9rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0.8rem;">
                        <input type="password" id="ownerPassword" placeholder="パスワード (ログイン用)" required
                            style="padding: 0.5rem; font-size: 0.9rem;">
                    </div>
                    <button type="submit" class="submit-btn" style="padding: 0.5rem; font-size: 0.9rem;">追加する</button>
                </form>
            </div>

            <!-- Existing Owners List -->
            <div class="admin-section">
                <h4>登録済みオーナー一覧</h4>
                <ul id="ownerList" class="reservation-list" style="max-height: 250px;">
                    <!-- List items generated dynamically -->
                </ul>
            </div>

            <!-- Password Change Shortcut -->
            <div class="admin-section"
                style="margin-top: 2rem; border-top: 1px solid var(--color-border); padding-top: 1rem;">
                <h4>セキュリティ</h4>
                <button id="changePasswordBtn" class="text-btn" style="color: var(--color-primary); font-weight: 500;">
                    <i class="fas fa-key"></i> ログイン中のパスワードを変更する
                </button>
            </div>
        </div>
    </div>

    <!-- User Account Modal (Login / Register) -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="tab-header">
                    <button id="tabLogin" class="tab-btn active">ログイン</button>
                    <button id="tabRegister" class="tab-btn">新規登録</button>
                </div>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <!-- Login View -->
            <div id="loginView">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginStudentId">学籍番号</label>
                        <input type="text" id="loginStudentId" required placeholder="00X0000">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">パスワード</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="actions">
                        <button type="submit" class="submit-btn">ログイン</button>
                    </div>
                </form>
            </div>

            <!-- Register View -->
            <div id="registerView" style="display: none;">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regName">氏名</label>
                        <input type="text" id="regName" required placeholder="宮本 太郎">
                    </div>
                    <div class="form-group">
                        <label for="regStudentId">学籍番号</label>
                        <input type="text" id="regStudentId" required placeholder="00X0000">
                    </div>
                    <div class="form-group">
                        <label for="regEmail">メールアドレス</label>
                        <input type="email" id="regEmail" required placeholder="student@university.ac.jp">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">パスワード</label>
                        <input type="password" id="regPassword" required minlength="4">
                    </div>
                    <div class="form-group"
                        style="display: flex; align-items: center; gap: 0.5rem; margin-top: -0.25rem; margin-bottom: 1.25rem;">
                        <input type="checkbox" id="regNotify" style="width: auto; margin: 0;" checked>
                        <label for="regNotify"
                            style="margin: 0; font-size: 0.9rem; font-weight: normal; cursor: pointer;">予約の完了・取消メールを受け取る</label>
                    </div>
                    <div class="actions">
                        <button type="submit" class="submit-btn"
                            style="background-color: var(--color-success);">アカウント作成</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- User Settings Modal -->
    <div id="userSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ユーザー設定</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="admin-section">
                <!-- Profile Settings -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">基本設定</h4>
                    <div class="form-group">
                        <label for="editUserEmail">メールアドレス</label>
                        <input type="email" id="editUserEmail" required style="padding: 0.6rem;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                        <input type="checkbox" id="userSettingsNotify" style="width: auto; margin: 0;">
                        <label for="userSettingsNotify"
                            style="margin: 0; font-size: 0.95rem; cursor: pointer;">予約の完了・取消メールを受け取る</label>
                    </div>
                </div>

                <!-- Password Settings -->
                <div style="border-top: 1px solid #e2e8f0; padding-top: 1.5rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">パスワード変更 <span
                            style="font-size:0.8rem; font-weight:normal; color:#718096;">(任意)</span></h4>
                    <div class="form-group">
                        <label for="editUserCurrentPwd">現在のパスワード</label>
                        <input type="password" id="editUserCurrentPwd" placeholder="変更する場合のみ入力">
                    </div>
                    <div class="form-group">
                        <label for="editUserNewPwd">新しいパスワード</label>
                        <input type="password" id="editUserNewPwd" minlength="4" placeholder="4文字以上">
                    </div>
                </div>
            </div>
            <div class="actions" style="justify-content: space-between; align-items: center;">
                <button id="deleteAccountBtn" class="text-btn"
                    style="color: #e53e3e; font-size: 0.9rem;">アカウント削除</button>
                <button id="saveUserSettingsBtn" class="submit-btn"
                    style="background-color: var(--color-primary);">設定を保存</button>
            </div>
        </div>
    </div>

    <!-- Batch Registration Modal -->
    <div id="batchRegistrationModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3>予約枠の一括登録</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <form id="batchRegistrationForm">
                <div class="admin-section">
                    <h4>1. 期間設定</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="batchStartDate">開始日</label>
                            <input type="date" id="batchStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="batchEndDate">終了日</label>
                            <input type="date" id="batchEndDate" required>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>2. 曜日選択</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label><input type="checkbox" name="batchDay" value="1"> 月</label>
                        <label><input type="checkbox" name="batchDay" value="2"> 火</label>
                        <label><input type="checkbox" name="batchDay" value="3"> 水</label>
                        <label><input type="checkbox" name="batchDay" value="4"> 木</label>
                        <label><input type="checkbox" name="batchDay" value="5"> 金</label>
                        <label><input type="checkbox" name="batchDay" value="6"> 土</label>
                        <label><input type="checkbox" name="batchDay" value="0"> 日</label>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>3. 時間帯設定</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="batchStartTime">開始時間</label>
                            <select id="batchStartTime">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="batchEndTime">終了時間</label>
                            <select id="batchEndTime">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit" class="submit-btn">一括登録する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student History Modal (Admin) -->
    <div id="studentHistoryModal" class="modal">
        <!-- Changed style to use flexbox column layout for better scrolling control -->
        <div class="modal-content admin-modal"
            style="max-width: 800px; display: flex; flex-direction: column; max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h3>学生情報・予約状況</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <!-- Split Layout -->
            <div class="user-history-split-layout" style="display: flex; height: 60vh; border-top: 1px solid #edf2f7;">
                <!-- Sidebar -->
                <div class="student-sidebar"
                    style="width: 250px; border-right: 1px solid #edf2f7; display: flex; flex-direction: column; background: #f8fafc;">
                    <div style="padding: 10px; border-bottom: 1px solid #e2e8f0; background: #fff;">
                        <input type="text" id="studentSearchInput" placeholder="名前やIDで検索..."
                            style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 0.9rem;">
                    </div>
                    <ul id="studentListSidebar" style="list-style: none; overflow-y: auto; flex: 1; padding: 0;">
                        <!-- List Items Populated by JS -->
                    </ul>
                </div>

                <!-- Main Content -->
                <div class="history-content-area" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #fff;">

                    <div id="studentInfoContainer">
                        <!-- Future Reservations Section -->
                        <div id="studentFutureSection" style="display:none; margin-bottom: 2rem;">
                            <h4
                                style="border-bottom: 2px solid #3182ce; padding-bottom: 0.5rem; color: #2c5282; margin-bottom: 1rem;">
                                <i class="fas fa-calendar-check" style="margin-right:8px;"></i>今後の予定
                            </h4>
                            <div id="studentFutureContent"></div>
                        </div>

                        <!-- Past History Section -->
                        <div id="studentHistorySection">
                            <h4
                                style="border-bottom: 2px solid #a0aec0; padding-bottom: 0.5rem; color: #4a5568; margin-bottom: 1rem;">
                                <i class="fas fa-history" style="margin-right:8px;"></i>過去の履歴
                            </h4>
                            <div id="studentHistoryContent"
                                style="padding: 10px; background: #f7fafc; border-radius: 4px;">
                                <div style="text-align:center; color:#718096; padding: 20px;">学生を選択すると情報が表示されます</div>
                            </div>
                        </div>
                    </div> <!-- End studentInfoContainer -->
                </div> <!-- End history-content-area -->
            </div> <!-- End user-history-split-layout -->
        </div> <!-- End modal-content -->
    </div> <!-- End studentHistoryModal -->

    <!-- My Page Modal (Student) -->
    <div id="myPageModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>マイページ</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <div
                style="background: #fdfdfd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #edf2f7; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div id="myPageStudentId" style="font-size: 0.85rem; color: #718096; margin-bottom: 2px;">
                    </div>
                    <div id="myPageStudentName" style="font-size: 1.25rem; font-weight: bold; color: #2d3748;">
                    </div>
                </div>
                <button id="myPageSettingsBtn" class="text-btn" style="color: #4a5568;"><i class="fas fa-cog"></i>
                    アカウント設定</button>
            </div>

            <div id="myPageContent" style="max-height: 65vh; overflow-y: auto; padding-right: 5px;">
                <!-- Future Reservations Section -->
                <div id="myPageFutureSection" style="display:none; margin-bottom: 2rem;">
                    <h4
                        style="border-bottom: 2px solid #3182ce; padding-bottom: 0.5rem; color: #2c5282; margin-bottom: 1rem;">
                        <i class="fas fa-calendar-check" style="margin-right:8px;"></i>これからの予約
                    </h4>
                    <div id="myPageFutureList"></div>
                </div>

                <!-- Past History Section -->
                <div id="myPagePastSection">
                    <h4
                        style="border-bottom: 2px solid #a0aec0; padding-bottom: 0.5rem; color: #4a5568; margin-bottom: 1rem;">
                        <i class="fas fa-archive" style="margin-right:8px;"></i>過去の予約・議事録アーカイブ
                    </h4>
                    <div id="myPagePastList" style="padding: 10px; background: #f7fafc; border-radius: 4px;">
                        <!-- Content injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification/Toast -->
    <div id="toast" class="toast">予約が完了しました</div>


    <div id="systemInfoFooter"
        style="text-align: center; margin-top: 2rem; padding: 1rem; color: #cbd5e0; font-size: 0.75rem;">
        System v2.0 | Connected to: <span id="connectedServerId">Checking...</span>
    </div>

    <script src="script.js?v=2.1"></script>

    <!-- User Management Modal (Admin) -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content admin-modal wide-modal">
            <div class="modal-header">
                <h3>学生ユーザー管理</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="admin-section">
                <p style="margin-bottom: 1rem; color: #4a5568;">登録済みの学生ユーザーを管理します。</p>
                <div class="user-list-container">
                    <div class="list-header user-list-grid user-list-header">
                        <div>氏名</div>
                        <div>学籍番号</div>
                        <div>メール</div>
                        <div style="text-align: center;">予約数</div>
                        <div style="text-align: center;">操作</div>
                    </div>
                    <ul id="userManagementList" style="list-style: none;">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Admin Menu Modal -->
    <div id="adminMenuModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>管理者メニュー</h3>
                <button class="close-btn closeModal"><i class="fas fa-times"></i></button>
            </div>

            <!-- Reservation Management section removed as buttons are back in header -->

            <div class="admin-menu-section" style="margin-bottom: 1.5rem;">
                <h4
                    style="border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--color-primary); font-size: 1rem;">
                    <i class="fas fa-users-cog" style="margin-right: 0.5rem;"></i>ユーザー・オーナー管理
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button id="menuOwnerManagementBtn" class="menu-action-btn">
                        <i class="fas fa-user-tie"></i>
                        <span>オーナー管理</span>
                    </button>
                    <button id="menuUserManagementBtn" class="menu-action-btn">
                        <i class="fas fa-user-graduate"></i>
                        <span>学生ユーザー管理</span>
                    </button>
                    <button id="menuStudentHistoryBtn" class="menu-action-btn">
                        <i class="fas fa-history"></i>
                        <span>学生履歴・アーカイブ</span>
                    </button>
                </div>
            </div>

            <div class="admin-menu-section">
                <h4
                    style="border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--color-primary); font-size: 1rem;">
                    <i class="fas fa-cogs" style="margin-right: 0.5rem;"></i>システム設定
                </h4>
                <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    <button id="menuChangePasswordBtn" class="menu-action-btn">
                        <i class="fas fa-key"></i>
                        <span>管理者パスワード変更</span>
                    </button>
                    <button id="menuForcePushBtn" class="menu-action-btn"
                        style="border-color: #e53e3e; color: #e53e3e;">
                        <i class="fas fa-database"></i>
                        <span>サーバーデータを強制上書き</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Details Modal -->
    <div id="reservationDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 style="color: var(--color-primary); font-size: 1.25rem;"><i class="fas fa-info-circle"></i> 予約詳細
                </h3>
                <button class="close-btn" id="closeReservationDetailsModal"><i class="fas fa-times"></i></button>
            </div>
            <div id="reservationDetailsBody" style="padding: 1rem; line-height: 1.8; color: #2d3748;">
                <!-- Details injected here -->
            </div>
            <div style="text-align: center; margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                <button class="btn-secondary" id="closeReservationDetailsBtn" style="min-width: 100px;">閉じる</button>
            </div>
        </div>
    </div>

</body>

</html>